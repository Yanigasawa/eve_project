import { fetchRemoteOrders } from "./fetchRemoteOrders";
import "@testing-library/jest-dom";
import { EveType } from "../types/etypes";

//declare global fetch function for use in each case of api call
global.fetch = jest.fn();

const evetype: EveType = {
  typeid: 54772,
  groupid: 4062,
  typename: "SlamBolt Condenser Pack S",
  description:
    "The project to adapt Arcing Vorton Projectors into ship-based weapons required the development of a high-capacity energy source for the new weapons. Ship capacitors are powerful but the immense bursts of energy required to fire Vorton Projectors called for the development of one-shot Condenser Packs capable of retaining ultra-high charges and rapidly discharging them at need. In a novel and elegant solution to the problem of cabling burnout in the projectors, the material of the Condenser Packs is designed to be rendered down into a pool of nanites the ablative nanocabling of the weapons can draw on.\n\nUpwell's brand of SlamBolt Condenser Packs are designed to deliver a pulse of power tuned to develop arcs dealing primarily Kinetic damage at long ranges.",
  capacity: "null",
  portionsize: 500,
  raceid: "0",
  published: true,
  iconid: 24473,
  marketgroupid: 2734,
  soundid: 0,
  graphicid: 24578,
  mass: 0.01,
  baseprice: 1000,
};

describe("fetchRemoteOrders", () => {
  let consoleErrorSpy: jest.SpyInstance;

  const mockResponse = {
    itemType: {
      typeID: 54771,
      groupID: 4062,
      typeName: "BlastShot Condenser Pack S",
      iconID: 24470,
      marketGroupID: 2734,
      description:
        "The project to adapt Arcing Vorton Projectors into ship-based weapons required the development of a high-capacity energy source for the new weapons. Ship capacitors are powerful but the immense bursts of energy required to fire Vorton Projectors called for the development of one-shot Condenser Packs capable of retaining ultra-high charges and rapidly discharging them at need. In a novel and elegant solution to the problem of cabling burnout in the projectors, the material of the Condenser Packs is designed to be rendered down into a pool of nanites the ablative nanocabling of the weapons can draw on.\r\n\r\nUpwell's brand of BlastShot Condenser Packs are designed to deliver a pulse of power tuned to develop arcs dealing high Kinetic damage at short ranges.",
      published: 1,
      volume: 0.0025,
    },
    producedBy: 54863,
    systems: {
      "30002537": {
        solarSystemID: 30002537,
        solarSystemName: "Amamake",
        security: 0.43876123,
      },
      "30002187": {
        solarSystemID: 30002187,
        solarSystemName: "Amarr",
        security: 1.0,
      },
      "30003018": {
        solarSystemID: 30003018,
        solarSystemName: "Azer",
        security: 0.6570695,
      },
      "30005199": {
        solarSystemID: 30005199,
        solarSystemName: "Tar",
        security: 0.75667727,
      },
      "30045324": {
        solarSystemID: 30045324,
        solarSystemName: "Onnamon",
        security: 0.5555345,
      },
      "30000142": {
        solarSystemID: 30000142,
        solarSystemName: "Jita",
        security: 0.94591314,
      },
      "30005038": {
        solarSystemID: 30005038,
        solarSystemName: "Kor-Azor Prime",
        security: 0.9139081,
      },
      "30002510": {
        solarSystemID: 30002510,
        solarSystemName: "Rens",
        security: 0.89458185,
      },
      "30004993": {
        solarSystemID: 30004993,
        solarSystemName: "Villore",
        security: 0.9,
      },
      "30001376": {
        solarSystemID: 30001376,
        solarSystemName: "Nourvukaiken",
        security: 0.81655675,
      },
      "30002659": {
        solarSystemID: 30002659,
        solarSystemName: "Dodixie",
        security: 0.8684067,
      },
      "30002661": {
        solarSystemID: 30002661,
        solarSystemName: "Botane",
        security: 0.8754401,
      },
      "30002053": {
        solarSystemID: 30002053,
        solarSystemName: "Hek",
        security: 0.8,
      },
      "30001671": {
        solarSystemID: 30001671,
        solarSystemName: "Tash-Murkon Prime",
        security: 0.8321339,
      },
      "30005304": {
        solarSystemID: 30005304,
        solarSystemName: "Alentene",
        security: 0.866783,
      },
      "30001658": {
        solarSystemID: 30001658,
        solarSystemName: "Mani",
        security: 0.8221446,
      },
      "30002781": {
        solarSystemID: 30002781,
        solarSystemName: "Halaima",
        security: 0.6589383,
      },
      "30000188": {
        solarSystemID: 30000188,
        solarSystemName: "Hentogaira",
        security: 0.5669583,
      },
      "30002385": {
        solarSystemID: 30002385,
        solarSystemName: "Teonusude",
        security: 0.5863137,
      },
      "30000144": {
        solarSystemID: 30000144,
        solarSystemName: "Perimeter",
        security: 0.9531232,
      },
      "30003794": {
        solarSystemID: 30003794,
        solarSystemName: "Stacmon",
        security: 0.60527974,
      },
      "30003830": {
        solarSystemID: 30003830,
        solarSystemName: "Orvolle",
        security: 0.7462382,
      },
    },
    stationNames: {
      "60011731": "Orvolle VI - Moon 1 - Federal Administration Bureau Offices",
      "60003760": "Jita IV - Moon 4 - Caldari Navy Assembly Plant",
      "60005686": "Hek VIII - Moon 12 - Boundless Creation Factory",
      "60002485":
        "Tash-Murkon Prime III - Moon 1 - Expert Distribution Retail Center",
      "60010261": "Azer III - Moon 6 - CreoDron Factory",
      "60013333": "Stacmon VII - Moon 1 - Impro Factory",
      "60003418": "Halaima VIII - Moon 17 - Mercantile Club Bureau",
      "60011866": "Dodixie IX - Moon 20 - Federation Navy Assembly Plant",
      "60015070": "Onnamon IV - State Protectorate Logistic Support",
      "60010396":
        "Alentene VI - Moon 16 - Poteque Pharmaceuticals Biotech Research Center",
      "60012739": "Tar III - Secure Commerce Commission Depository",
      "60003298": "Nourvukaiken II - Moon 1 - Modern Finances Depository",
      "60008422": "Mani VII - Moon 10 - Amarr Navy Assembly Plant",
      "60002212":
        "Kor-Azor Prime IV (Eclipticum) - Moon Griklaeum - Ishukone Corporation Factory",
      "60004552": "Teonusude VII - Moon 1 - Vherokior Tribe Treasury",
      "60009928": "Villore VII - Moon 8 - Quafe Company Factory",
      "60008494": "Amarr VIII (Oris) - Emperor Family Academy",
      "60000685": "Perimeter VII - Poksu Mineral Group Mineral Reserve",
      "60004588": "Rens VI - Moon 8 - Brutor Tribe Treasury",
    },
    structureNames: {
      "1043159223409": "Hentogaira - EDI-HQ",
      "1022167642188": "Amamake - 5 Times nearly AT winners",
      "1044961079041": "Botane - 0.3% Cheapest Market",
    },
    orders: [
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1735328581000,
        locationId: 60002485,
        minVolume: 1,
        orderId: 6828788538,
        price: 26400.0,
        range: "REGION",
        systemId: 30001671,
        regionId: 10000020,
        typeId: 54771,
        volumeRemain: 4979,
        volumeTotal: 5179,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1736693216000,
        locationId: 1044961079041,
        minVolume: 1,
        orderId: 6950748331,
        price: 990.2,
        range: "_10",
        systemId: 30002661,
        regionId: 10000032,
        typeId: 54771,
        volumeRemain: 1224,
        volumeTotal: 1224,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1735390063000,
        locationId: 60009928,
        minVolume: 1,
        orderId: 6950816767,
        price: 14220.0,
        range: "REGION",
        systemId: 30004993,
        regionId: 10000064,
        typeId: 54771,
        volumeRemain: 4999,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739692190000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6988091646,
        price: 22000.0,
        range: "REGION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 3350,
        volumeTotal: 3430,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1735137826000,
        locationId: 60008422,
        minVolume: 1,
        orderId: 6702526841,
        price: 48830.0,
        range: "REGION",
        systemId: 30001658,
        regionId: 10000020,
        typeId: 54771,
        volumeRemain: 712,
        volumeTotal: 1222,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1736873631000,
        locationId: 60011866,
        minVolume: 1,
        orderId: 6696919661,
        price: 1000.0,
        range: "_40",
        systemId: 30002659,
        regionId: 10000032,
        typeId: 54771,
        volumeRemain: 4359,
        volumeTotal: 10000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1738444396000,
        locationId: 60011866,
        minVolume: 1,
        orderId: 6896877181,
        price: 12520.0,
        range: "REGION",
        systemId: 30002659,
        regionId: 10000032,
        typeId: 54771,
        volumeRemain: 2269,
        volumeTotal: 3419,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1736117051000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6951323475,
        price: 3719.0,
        range: "STATION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 4575,
        volumeTotal: 10000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1738826235000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6975327071,
        price: 3884.0,
        range: "STATION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 1933,
        volumeTotal: 2500,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1738680612000,
        locationId: 60008494,
        minVolume: 1,
        orderId: 6915201260,
        price: 823.5,
        range: "_5",
        systemId: 30002187,
        regionId: 10000043,
        typeId: 54771,
        volumeRemain: 1382,
        volumeTotal: 1709,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1738787596000,
        locationId: 60003298,
        minVolume: 1,
        orderId: 6980469042,
        price: 12580.0,
        range: "REGION",
        systemId: 30001376,
        regionId: 10000016,
        typeId: 54771,
        volumeRemain: 5000,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739715446000,
        locationId: 60002212,
        minVolume: 1,
        orderId: 6923787621,
        price: 15060.0,
        range: "REGION",
        systemId: 30005038,
        regionId: 10000065,
        typeId: 54771,
        volumeRemain: 4994,
        volumeTotal: 4998,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1735891672000,
        locationId: 60011866,
        minVolume: 1,
        orderId: 6906999005,
        price: 989.7,
        range: "_5",
        systemId: 30002659,
        regionId: 10000032,
        typeId: 54771,
        volumeRemain: 4000,
        volumeTotal: 4000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1737425397000,
        locationId: 60005686,
        minVolume: 1,
        orderId: 6968994803,
        price: 0.02,
        range: "_40",
        systemId: 30002053,
        regionId: 10000042,
        typeId: 54771,
        volumeRemain: 10000000,
        volumeTotal: 10000000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1739845757000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6988529642,
        price: 4284.0,
        range: "_3",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 3949,
        volumeTotal: 4029,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1732614353000,
        locationId: 60004588,
        minVolume: 1,
        orderId: 6925761153,
        price: 0.02,
        range: "_40",
        systemId: 30002510,
        regionId: 10000030,
        typeId: 54771,
        volumeRemain: 10000000,
        volumeTotal: 10000000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1739130077000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6970932305,
        price: 3904.0,
        range: "STATION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 1898,
        volumeTotal: 3000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1739817246000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6988600065,
        price: 4280.0,
        range: "STATION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 9201,
        volumeTotal: 9201,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1732284704000,
        locationId: 60011866,
        minVolume: 1,
        orderId: 6922466855,
        price: 0.02,
        range: "_40",
        systemId: 30002659,
        regionId: 10000032,
        typeId: 54771,
        volumeRemain: 10000000,
        volumeTotal: 10000000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1737266562000,
        locationId: 1043159223409,
        minVolume: 1,
        orderId: 6967514032,
        price: 9539.0,
        range: "REGION",
        systemId: 30000188,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 5000,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739740032000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6988677034,
        price: 21990.0,
        range: "REGION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 3349,
        volumeTotal: 3350,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739032079000,
        locationId: 60011731,
        minVolume: 1,
        orderId: 6854152699,
        price: 34230.0,
        range: "REGION",
        systemId: 30003830,
        regionId: 10000048,
        typeId: 54771,
        volumeRemain: 5000,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1735238423000,
        locationId: 60013333,
        minVolume: 1,
        orderId: 6831425660,
        price: 26400.0,
        range: "REGION",
        systemId: 30003794,
        regionId: 10000048,
        typeId: 54771,
        volumeRemain: 5184,
        volumeTotal: 5184,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739038139000,
        locationId: 60004552,
        minVolume: 1,
        orderId: 6854195405,
        price: 34230.0,
        range: "REGION",
        systemId: 30002385,
        regionId: 10000028,
        typeId: 54771,
        volumeRemain: 5000,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1737020857000,
        locationId: 60002485,
        minVolume: 1,
        orderId: 6840118866,
        price: 1644.0,
        range: "REGION",
        systemId: 30001671,
        regionId: 10000020,
        typeId: 54771,
        volumeRemain: 20000,
        volumeTotal: 20000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1734353296000,
        locationId: 60000685,
        minVolume: 1,
        orderId: 6828114734,
        price: 19.1,
        range: "_40",
        systemId: 30000144,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 8960,
        volumeTotal: 10000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1734646217000,
        locationId: 1022167642188,
        minVolume: 1,
        orderId: 6828192811,
        price: 26400.0,
        range: "REGION",
        systemId: 30002537,
        regionId: 10000030,
        typeId: 54771,
        volumeRemain: 3200,
        volumeTotal: 5200,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1738788032000,
        locationId: 60010396,
        minVolume: 1,
        orderId: 6851600585,
        price: 34230.0,
        range: "REGION",
        systemId: 30005304,
        regionId: 10000068,
        typeId: 54771,
        volumeRemain: 3199,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739813878000,
        locationId: 60011866,
        minVolume: 1,
        orderId: 6982405258,
        price: 12340.0,
        range: "REGION",
        systemId: 30002659,
        regionId: 10000032,
        typeId: 54771,
        volumeRemain: 6650,
        volumeTotal: 20000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1738974763000,
        locationId: 60010261,
        minVolume: 1,
        orderId: 6851628711,
        price: 34230.0,
        range: "REGION",
        systemId: 30003018,
        regionId: 10000037,
        typeId: 54771,
        volumeRemain: 5000,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739603786000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6987206551,
        price: 24210.0,
        range: "REGION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 3223,
        volumeTotal: 4321,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739035691000,
        locationId: 60012739,
        minVolume: 1,
        orderId: 6982480880,
        price: 12580.0,
        range: "REGION",
        systemId: 30005199,
        regionId: 10000067,
        typeId: 54771,
        volumeRemain: 4500,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1733048627000,
        locationId: 60008494,
        minVolume: 1,
        orderId: 6929644170,
        price: 792.0,
        range: "REGION",
        systemId: 30002187,
        regionId: 10000043,
        typeId: 54771,
        volumeRemain: 35000,
        volumeTotal: 35000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1739912794000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6982623845,
        price: 4285.0,
        range: "STATION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 4980,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1736578623000,
        locationId: 60015070,
        minVolume: 1,
        orderId: 6961541196,
        price: 11000.0,
        range: "REGION",
        systemId: 30045324,
        regionId: 10000069,
        typeId: 54771,
        volumeRemain: 4200,
        volumeTotal: 4200,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1739761653000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6971398842,
        price: 4269.0,
        range: "STATION",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 10000,
        volumeTotal: 10000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1739226577000,
        locationId: 60008494,
        minVolume: 1,
        orderId: 6984271514,
        price: 24990.0,
        range: "REGION",
        systemId: 30002187,
        regionId: 10000043,
        typeId: 54771,
        volumeRemain: 1000,
        volumeTotal: 1000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1738430563000,
        locationId: 60008494,
        minVolume: 1,
        orderId: 6950348829,
        price: 823.4,
        range: "_1",
        systemId: 30002187,
        regionId: 10000043,
        typeId: 54771,
        volumeRemain: 2831,
        volumeTotal: 10000,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1734366300000,
        locationId: 60004588,
        minVolume: 1,
        orderId: 6941931797,
        price: 49980.0,
        range: "REGION",
        systemId: 30002510,
        regionId: 10000030,
        typeId: 54771,
        volumeRemain: 932,
        volumeTotal: 2258,
      },
      {
        duration: 90,
        isBuyOrder: false,
        issued: 1737911544000,
        locationId: 60003418,
        minVolume: 1,
        orderId: 6973126795,
        price: 12580.0,
        range: "REGION",
        systemId: 30002781,
        regionId: 10000033,
        typeId: 54771,
        volumeRemain: 4000,
        volumeTotal: 4500,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1732166091000,
        locationId: 60003760,
        minVolume: 1,
        orderId: 6921460171,
        price: 0.02,
        range: "_40",
        systemId: 30000142,
        regionId: 10000002,
        typeId: 54771,
        volumeRemain: 10000000,
        volumeTotal: 10000000,
      },
      {
        duration: 30,
        isBuyOrder: false,
        issued: 1739758596000,
        locationId: 60011866,
        minVolume: 1,
        orderId: 6969806305,
        price: 12350.0,
        range: "REGION",
        systemId: 30002659,
        regionId: 10000032,
        typeId: 54771,
        volumeRemain: 302,
        volumeTotal: 632,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1732172426000,
        locationId: 60008494,
        minVolume: 1,
        orderId: 6921501983,
        price: 0.02,
        range: "_40",
        systemId: 30002187,
        regionId: 10000043,
        typeId: 54771,
        volumeRemain: 10000000,
        volumeTotal: 10000000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1737926784000,
        locationId: 60005686,
        minVolume: 1,
        orderId: 6973329496,
        price: 1500.0,
        range: "STATION",
        systemId: 30002053,
        regionId: 10000042,
        typeId: 54771,
        volumeRemain: 5000,
        volumeTotal: 5000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1737927684000,
        locationId: 60004588,
        minVolume: 1,
        orderId: 6973340023,
        price: 500.0,
        range: "STATION",
        systemId: 30002510,
        regionId: 10000030,
        typeId: 54771,
        volumeRemain: 15000,
        volumeTotal: 15000,
      },
      {
        duration: 90,
        isBuyOrder: true,
        issued: 1737929427000,
        locationId: 60008494,
        minVolume: 1,
        orderId: 6973358386,
        price: 820.0,
        range: "STATION",
        systemId: 30002187,
        regionId: 10000043,
        typeId: 54771,
        volumeRemain: 3000,
        volumeTotal: 3000,
      },
    ],
  };

  beforeEach(() => {
    jest.clearAllMocks();
    //spy on takes the function and the argument, so console.error is spyOn.(console, "error")
    //mockImplementation overides the expected behavior of console.error, cleaning up our output
    consoleErrorSpy = jest.spyOn(console, "error").mockImplementation(() => {});
  });
  afterEach(() => {
    //after each test, restore the expected behavior of console.error
    //this competes with the beforeEach, making this redundant, but there will be times we want console.console.error to behave as expected
    consoleErrorSpy.mockRestore();
  });

  test("fetches remote orders from eve tycoon, and returns the representation of an EveTycoonObject in Parsed JSON", async () => {
    (fetch as jest.Mock).mockResolvedValue({
      json: jest.fn().mockResolvedValue(mockResponse),
      //we use mockResolvedValue because it specifies the return of an async function
      //we would use mockReturnValue if this was synchronus
    });

    const result = await fetchRemoteOrders(evetype);

    expect(fetch).toHaveBeenCalledWith("/api/orders/remote/54772");
    expect(result).toEqual(mockResponse);
  });

  test("handles fetch failure and returns an empty object", async () => {
    (fetch as jest.Mock).mockRejectedValue(
      new Error("Error fetching orders: "),
    );

    const result = await fetchRemoteOrders(evetype);

    expect(console.error).toHaveBeenCalled();
    expect(result).toEqual({});
  });
});
